
use tkopengl;

Texture tex;

if(tex.loadLocalImage(Arguments.get(0), 0,0,4))
{
   int y = 0;
   loop(tex.sy)
   {
      int x = 0;
      loop(tex.sx)
      {
         int c32 = tex.getXY32(x, y);
         int r = (c32 >> 16) & 255;
         int g = (c32 >>  8) & 255;
         int b = (c32      ) & 255;
         int r5 = ((r >> 3) << 3) | (r >> 5);
         int g6 = ((g >> 2) << 2) | (g >> 6);
         int b5 = ((b >> 3) << 3) | (b >> 5);
         tex.setXY32(x, y, argb(255, r5, g6, b5));
         int errR = (r - r5);
         int errG = (g - g6);
         int errB = (b - b5);

         int c32n;
         int rn;
         int gn;
         int bn;

         if( (x+1) < tex.sx )
         {
            c32n = tex.getXY32(x+1, y);
            rn = (c32n >> 16) & 255;
            gn = (c32n >>  8) & 255;
            bn = (c32n      ) & 255;
            tex.setXY32(x+1, y, argb(255,
                                     mathClampi(rn + errR*7.0/16, 0, 255),
                                     mathClampi(gn + errG*7.0/16, 0, 255),
                                     mathClampi(bn + errB*7.0/16, 0, 255)
                                     )
                        );
         }

         if( (x > 0) && ((y+1) < tex.sy) )
         {
            c32n = tex.getXY32(x-1, y+1);
            rn = (c32n >> 16) & 255;
            gn = (c32n >>  8) & 255;
            bn = (c32n      ) & 255;
            tex.setXY32(x-1, y+1, argb(255,
                                       mathClampi(rn + errR*3.0/16, 0, 255),
                                       mathClampi(gn + errG*3.0/16, 0, 255),
                                       mathClampi(bn + errB*3.0/16, 0, 255)
                                       )
                        );
         }

         if( ((y+1) < tex.sy) )
         {
            c32n = tex.getXY32(x, y+1);
            rn = (c32n >> 16) & 255;
            gn = (c32n >>  8) & 255;
            bn = (c32n      ) & 255;
            tex.setXY32(x, y+1, argb(255,
                                     mathClampi(rn + errR*5.0/16, 0, 255),
                                     mathClampi(gn + errG*5.0/16, 0, 255),
                                     mathClampi(bn + errB*5.0/16, 0, 255)
                                     )
                        );
         }

         if( ((x+1) < tex.sx) && ((y+1) < tex.sy) )
         {
            c32n = tex.getXY32(x+1, y+1);
            rn = (c32n >> 16) & 255;
            gn = (c32n >>  8) & 255;
            bn = (c32n      ) & 255;
            tex.setXY32(x+1, y+1, argb(255,
                                       mathClampi(rn + errR*1.0/16, 0, 255),
                                       mathClampi(gn + errG*1.0/16, 0, 255),
                                       mathClampi(bn + errB*1.0/16, 0, 255)
                                       )
                        );
         }

         x++;
      }
      y++;
   }
}

tex.saveImage("debug.png");
