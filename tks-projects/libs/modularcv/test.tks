// ----
// ---- file   : test.tks
// ---- author : Bastian Spiegel <bs@tkscript.de>
// ---- legal  : (c) 2021 by Bastian Spiegel. 
// ----          Distributed under terms of the GNU LESSER GENERAL PUBLIC LICENSE (LGPL). See 
// ----          http://www.gnu.org/licenses/licenses.html#LGPL or COPYING for further information.
// ----
// ---- info   : 
// ----
// ---- created: 26Mar2021
// ---- changed: 27Mar2021
// ----
// ----
// ----

module Main;

use namespace modularcv;


Patch p;
p.init();

ModCV_Output o1;
o1.init();
p.addModule(deref o1);

ModCV_Const c1;
c1.init();
c1.c1 = 0.75;
c1.c2 = -0.5;
p.addModule(deref c1);

ModCV_RingMod rm1;
rm1.init();
p.addModule(deref rm1);

rm1.connect(0, c1, 0);
rm1.connect(1, c1, 1);
o1.connect(0, rm1, 0);

// Save+Restore
Buffer ioBuf;
ioBuf.size = 65*1024;
p.saveState(ioBuf);
p.deleteAllModules();
ioBuf.offset = 0;
p.loadState(ioBuf);

// Benchmark
int t = milliSeconds();
loop(1000000)
{
   p.tick();
}
t = milliSeconds() - t;
trace (1000000.0 / t)+" iterations/millisecond (t="+t+")";  // => ~444

trace "p.out[0]="+p.output_values.get(0);
