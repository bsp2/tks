
use tkmidi;
use tkmidipipe;

LocalMIDI localmidi;

if(localmidi.connect("localmidi_test", 4*1024*1024))
{
   trace "ok";
   Buffer b; b.size = 1024; b.fillZero();
   if(localmidi.recv(b))
   {
      trace "recv "+b.offset+" bytes";

      MIDIIn midiin;
      midiin.parseBuffer(b);

      trace "numEvents="+midiin.numEvents;

      loop(midiin.numEvents)
      {
         RecordedMIDIEvent ev <= midiin.nextEvent;
         if(!ev.isLongMessage())
         {
            // Short message
            Integer io1 = ev.shortMessage & 255;
            Integer io2 = (ev.shortMessage >> 8) & 255;
            Integer io3 = (ev.shortMessage >> 16) & 255;
            trace "shortmsg=$"+io1.printf("%02x")+" $"+io2.printf("%02x")+" $"+io3.printf("%02x");
         }
         else
         {
            // SysEx
            trace "SysEx sz="+ev.size;
            Buffer sysex; sysex.size = 64*1024;
            sysex.offset = 0;
            sysex.i8 = $F0;
            ev.copyToStream(sysex);
            sysex.i8 = $F7;
            sysex.hexdump(0, sysex.offset);
         }
      }

      // b.offset = 0;
      // String s;
      // b.readString(s, 64);
      // trace "got string \""+s+"\"";

      localmidi.disconnect();
      trace "disconnected";
   }
}
