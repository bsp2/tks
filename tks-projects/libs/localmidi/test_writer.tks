
use tkmidipipe;

LocalMIDI localmidi;

if(localmidi.create("localmidi_test", 4*1024*1024))
{
   trace "ok";
   if(localmidi.waitForConnection(30*1000))
   {
      trace "reader connected";

      // Buffer b; b.size = 1024; b.fillZero();
      // b.offset = 0;
      // b.writeString("hello from localmidi writer", 0,0);
      // localmidi.send(b);

      MIDIPipeRoot pipeRoot;
      pipeRoot.allocDeviceSlots(1);
      MIDIPipeDevice pipeDev <= pipeRoot.allocDevice(0);
      // MIDIPipeFrame pipeFrameMaster;
      // MIDIPipeFrame pipeFramePlay;
      // MIDIPipeFrame pipeFrameRec;
      MIDIPipeFrame fr;
      fr.root = pipeRoot;
      Buffer cmdBuf; cmdBuf.size = 256*1024;
      Buffer noteBuf; noteBuf.size = 256*1024;
      pipeDev.setBuffers(cmdBuf, noteBuf);
      Buffer sysex; sysex.size = 5;
      sysex.i8 = $F0;
      sysex.i8 = $01;
      sysex.i8 = $31;
      sysex.i8 = $06;
      sysex.i8 = $F7;

      fr.cc(true/*bSet*/, 0/*devIdx*/, 0/*midiCh*/, 1/*ccId*/, 64);
      fr.noteOn(true/*bSet*/, 0/*devIdx*/, 0/*midiCh*/, 5*12/*note*/, 127/*vel*/, 0/*dur*/);
      fr.sysex(true/*bSet*/, 0/*devIdx*/, sysex);

      cmdBuf.offset = 0;
      noteBuf.offset = 0;
      fr.emit();

      localmidi.send(cmdBuf);
      trace "sent "+cmdBuf.offset+" bytes";

      localmidi.send(noteBuf);
      trace "sent "+noteBuf.offset+" bytes";

      localmidi.waitForDisconnect(5*1000);
      trace "reader disconnected";
   }
}
