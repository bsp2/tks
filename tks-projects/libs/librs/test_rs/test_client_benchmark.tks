// 17Aug2024, 18Aug2024, 19Aug2024, 20Aug2024, 21Aug2024, 22Aug2024, 23Aug2024

// (todo) update Linux/WSL2  Linux/VirtualBox results

// RPCs per second (req+reply roundtrip via SHM):
//                               macOS  Linux  Windows 10  Windows 11
//   --keep-alive                40387   6111        1514       10822
//   --keep-alive -s             31716   5436           -           -
//   --keep-alive --no-exec     266667  75528       94877      119048
//   --keep-alive --no-exec -s   64409  38461           -           -
//   test_eval (exec only)       50276  13510       12436       15811

//
// [on macOS/m2pro] test_poll: 1.923.076 iterations/sec
//

RemoteScriptClient client;

if( (Arguments & "--keep-alive") || (Arguments & "-k") )
   client.setEnableKeepAlive(true);
if( (Arguments & "--yield")      || (Arguments & "-y") )
   client.setEnableYield(true);
if( (Arguments & "--debug")      || (Arguments & "-d") )
   client.setEnableDebug(true);
if( (Arguments & "--sigusr1")    || (Arguments & "-s") )  // OS-friendly (no polling)
   client.setEnableSIGUSR1(true);

if(client.initRemoteScriptClient("test_host", 0/*reqSz=def*/))
{

   Integer reqIdx = 0;
   int tStart = milliSeconds();
   int numIter = 100000;
   int iter = 0;
   loop(numIter)
   {
      client.evalScript("int i = "+(++iter)+";");
   }
   int tDelta = milliSeconds() - tStart;
   float cps = (1000.0f * numIter) / tDelta;
   trace "[...] "+iter+" iterations in "+tDelta+" ms => "+cps+" iterations / second";
   client.exit();
}
