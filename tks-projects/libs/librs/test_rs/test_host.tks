// 17Aug2024, 18Aug2024, 19Aug2024, 21Aug2024, 23Aug2024

// trace "xxx this Process.GetPID()="+Process.GetPID();

boolean b_exec = true;
if( (Arguments & "--no-exec") || (Arguments & "-n") )
   b_exec = false;


class MyAPI {
   // some test code that is accessible by remote scripts
   static int i = 42;
   static float f = PI;
   static String s = "mystring";

   static Add(var a, var b) { return a + b; }
}

class MyHost : RemoteScriptHost {

   public virtual handleRequest(local String _sReq) : String {
      if(b_debug) trace "[trc] MyHost::handleRequest: sReq=\""+_sReq+"\"";
      return b_exec ? RemoteScriptHost::handleRequest(_sReq) : "test";
   }
}

MyHost host;

if( (Arguments & "--debug")      || (Arguments & "-d") )
   host.setEnableDebug(true);
if( (Arguments & "--keep-alive") || (Arguments & "-k") )
   host.setEnableKeepAlive(true);
if( (Arguments & "--yield")      || (Arguments & "-y") )
   host.setEnableYield(true);
if( (Arguments & "--sigusr1")    || (Arguments & "-s") )
   host.setEnableSIGUSR1(true);

host.setLineOffset(2);
host.setEnableTangle(true);
// host.setTangleOutputPathname("autogen_tangle_output.tks");

if(host.initRemoteScriptHost("test_host", 0/*reqSz=def*/))
{
   Integer reqIdx = 0;
   for(;;)
   {
      if(host.processNextRequest())
      {
         if(host.b_debug) trace "[dbg] host: ["+((reqIdx++).printf("%05d"))+"] processNextRequest() finished";
      }
      else if(host.b_yield)
      {
         TKS.yield();
      }
   }
   host.exit();
}
