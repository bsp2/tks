// 20Apr2022

String bufMSP;
String bufSYX;

if(bufSYX.loadLocal("../sub37_autogen.msp", true/*bRemoveCR*/))
{
   if(bufMSP.loadLocal("moog_sub37_input.msp", true/*bRemoveCR*/))
   {
      StringArray syxLines <= bufSYX.splitChar('\n');
      // StringArray mspLines <= bufMSP.splitChar('\n');

      // iterate nrpn aliases
      int idxMSP = 0;
      int numFound = 0;
      int numNotFound = 0;
      for(;;)
      {
         idxMSP = bufMSP.indexOf("<nrpn id=", idxMSP);
         trace "xxx idxMSP="+idxMSP;
         if(-1 != idxMSP)
         {
            int idxIdStart = idxMSP + 9;
            int idxIdEnd = bufMSP.indexOf(" ", idxIdStart);
            String id = bufMSP.substring(idxIdStart, idxIdEnd - idxIdStart);
            trace "xxx id=\""+id+"\"";
            int idxInsert = bufMSP.indexOf("        SYXMERGE=1", idxIdEnd);
            int idxTagEnd = bufMSP.indexOf("/>", idxIdEnd);

            boolean bFoundSYX = false;

            if((-1 != idxInsert) && (idxInsert < idxTagEnd))
            {
               // Find SYX entry
               String *syxLine;
               int syxLineIdx = 0;
               foreach syxLine in syxLines
               {
                  if(syxLine & ("id="+id))
                  {
                     syxLineIdx++;
                     String bufInsert; bufInsert.empty();
                     for(;;)
                     {
                        syxLine <= syxLines.get(syxLineIdx);
                        trace "xxx syxLine=\""+syxLine+"\"";
                        if(syxLine & "/>")
                           break;
                        bufInsert.append(syxLine+"\n");
                        syxLineIdx++;
                     }
                     bufInsert.append("  ");
                     bufMSP.replaceRegion(idxInsert, idxInsert + (idxTagEnd - idxInsert), bufInsert);
                     bFoundSYX = true;
                     break;
                  }
                  syxLineIdx++;
               }
            }

            if(bFoundSYX)
            {
               trace "[+++] found SYX entry id=\""+id+"\"";
               numFound++;
            }
            else
            {
               trace "[~~~] SYX entry id=\""+id+"\" not found";
               numNotFound++;
            }

            // Next id
            idxMSP = idxIdEnd;
         }
         else
            break;
      }

      bufMSP.saveLocal("moog_sub37_merged.msp");
      trace "numFound="+numFound+" numNotFound="+numNotFound;
   }
}

